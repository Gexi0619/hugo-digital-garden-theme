{{ define "main" }}

{{- /* Collect all tags from linktree data */ -}}
{{- $allTags := slice -}}
{{- if .Site.Data.linktree.links -}}
  {{- range .Site.Data.linktree.links -}}
    {{- with .tags -}}
      {{- range . -}}
        {{- $allTags = $allTags | append (. | urlize) -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- $allTags = $allTags | uniq | sort -}}
{{- end -}}

<div class="page-wrapper page-wrapper--narrow">
  <div class="pt-5 pb-3">
    <div class="d-flex align-items-start gap-4">
      <div>
        {{- $titleId := .Title | urlize -}}
        {{- $linkUrl := printf "%s#%s" .Permalink $titleId -}}
        <h1 class="display-2 mb-4" id="{{ $titleId }}">
          {{ .Title }}
          <button
             type="button"
             class="anchor"
             data-title="Copy link to clipboard"
             aria-label="Copy link to clipboard"
             onclick="navigator.clipboard.writeText('{{ $linkUrl | safeURL }}');this.insertAdjacentHTML('afterend', '<div class=link-copied>Link copied</div>');setTimeout(() => { document.querySelectorAll('.link-copied').forEach(el => el.remove()); }, 3000);"
          >
             <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 96 960 960" width="1em">
                 <path d="M450 776H280q-83 0-141.5-58.5T80 576q0-83 58.5-141.5T280 376h170v60H280q-58.333 0-99.167 40.765-40.833 40.764-40.833 99Q140 634 180.833 675q40.834 41 99.167 41h170v60ZM325 606v-60h310v60H325Zm185 170v-60h170q58.333 0 99.167-40.765 40.833-40.764 40.833-99Q820 518 779.167 477 738.333 436 680 436H510v-60h170q83 0 141.5 58.5T880 576q0 83-58.5 141.5T680 776H510Z"/>
             </svg>
          </button>
        </h1>
        <p class="bio fs-4 body-text">{{ .Summary }}</p>
      </div>
      <img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data={{ .Permalink }}" alt="QR Code for {{ .Title }}" class="linktree-qr" style="width: 100px; height: 100px; flex-shrink: 0; margin-left: auto;">
    </div>
  </div>

  {{- /* Render linktree items */ -}}
  {{ if .Site.Data.linktree.links }}
  <div class="row row-cols-1 g-2 mb-5" id="linktree-links">
    {{- $sorted := sort .Site.Data.linktree.links "weight" -}}
    {{- $sorted = sort $sorted "status" -}}
    {{- range $sorted -}}
    {{- $classes := slice "linktree-item" -}}
    {{- with .tags -}}
      {{- range . -}}
        {{- $classes = $classes | append (. | urlize | printf "iso-%s") -}}
      {{- end -}}
    {{- end -}}

    <div class="col {{ delimit $classes " " }}">
      <div class="card h-100 top-highlight">
        <div class="card-body">
          <div class="row align-items-center justify-content-between">
            <div class="col-auto d-flex align-items-center gap-3">
              <img src="https://cdn.simpleicons.org/{{ .icon }}" alt="{{ .title }}" class="linktree-icon">
              <h5 class="card-title mb-0">{{ .title }}</h5>
            </div>
            <div class="col-auto">
              <p class="card-right mb-0">
                {{- if .note }}<span class="card-date">{{ .note }}</span>{{ end -}}
                {{- if .status }}<span class="linktree-status linktree-status-{{ .status }}" title="{{ .status }}"></span>{{ end -}}
              </p>
            </div>
          </div>
          <a href="{{ .url }}" class="stretched-link" {{ if .new_tab }}target="_blank" rel="noopener"{{ end }}></a>
        </div>
      </div>
    </div>
    {{- end -}}
  </div>
  {{ end }}

  {{- /* Filter Buttons */ -}}
  {{ if $allTags }}
  <div class="mt-4">
    <div class="btn-toolbar mb-2 bio" role="toolbar" aria-label="Tag filters">
      <div id="filters" class="button-group">
        <i class="fas fa-filter"></i>
        {{ range $allTags }}
        {{ $btnid := . | printf "iso-%s" }}
        <input type="checkbox" class="btn-check" id="{{ $btnid }}" autocomplete="off">
        <label class="button" for="{{ $btnid }}">{{ . }}</label>
        {{ end }}
      </div>
    </div>
  </div>
  {{ end }}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var $container = $('#linktree-links');
  if (!$container.length) return;

  $container.isotope({
    itemSelector: '.linktree-item',
    layoutMode: 'fitRows',
    percentPosition: true
  });

  $('#filters input').change(function() {
    var filters = [];
    $('#filters input:checked').each(function() {
      filters.push('.' + this.id);
    });
    var selector = filters.length ? filters.join(', ') : '*';
    $container.isotope({ filter: selector });
  });
});
</script>

{{ end }}
