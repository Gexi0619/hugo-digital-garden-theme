{{- /* Unified section partial - for home page sections
     Receives: dict "ctx" $ "name" .name "limit" .limit "display" .display "show" .show
     display: "list" | "grid" | "full"
     show: slice of field names e.g. ["summary", "tags", "date", "lastmod", "status", "image"]
*/ -}}
{{- $ctx := .ctx -}}
{{- $name := .name -}}
{{- $limit := .limit -}}
{{- $display := .display | default "list" -}}
{{- $show := .show -}}

<section class="home-section">
	{{- with $ctx.Site.GetPage "section" $name -}}
	<div class="pb-3">
		{{ partial "section_heading.html" (dict "page" . "count" (len .RegularPages) "isLink" true "showCount" (ne $display "full")) }}
	</div>
	{{ if .Summary }}<p class="subheading">{{ .Summary }}</p>{{ end }}
	{{- end -}}

	{{- $allPages := where $ctx.Site.RegularPages "Section" $name -}}
	{{- $pingPages := (where $allPages "Params.ping" true).ByWeight -}}
	{{- $pages := slice -}}
	{{- if gt (len $pingPages) 0 -}}
		{{- $pingCount := len $pingPages -}}
		{{- if ge $pingCount $limit -}}
			{{- $pages = first $limit $pingPages -}}
		{{- else -}}
			{{- $nonPingPages := (where $allPages "Params.ping" "ne" true).ByWeight -}}
			{{- $remaining := sub $limit $pingCount -}}
			{{- $pages = $pingPages | append (first $remaining $nonPingPages) -}}
		{{- end -}}
	{{- else -}}
		{{- $pages = $allPages.ByLastmod.Reverse | first $limit -}}
	{{- end -}}

	{{ if eq $display "list" }}
		{{ partial "display_list.html" (dict "pages" $pages "show" $show) }}
	{{ else if eq $display "grid" }}
		{{ partial "display_grid.html" (dict "pages" $pages "show" $show) }}
	{{ else if eq $display "full" }}
		{{ partial "display_full.html" (dict "pages" $pages "show" $show) }}
	{{ end }}
</section>
